
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes cartes cadeaux</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1em;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, button, label {
      font-size: 1em;
      padding: 0.5em;
      margin: 0.5em 0;
      width: 100%;
      box-sizing: border-box;
      display: block;
    }
    img {
      max-width: 100%;
      border-radius: 4px;
      margin-top: 0.5em;
    }
    .history {
      font-size: 0.9em;
      color: #555;
    }
    .actions button {
      margin-right: 5px;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 1em;
    }
    .success {
      color: green;
      font-weight: bold;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h1>Mes cartes cadeaux</h1>
  <div class="card">
    <input type="text" id="nom" placeholder="Nom de la carte">
    <input type="number" id="solde" placeholder="Solde initial (â‚¬)">
    <input type="date" id="expiration" placeholder="Date d'expiration">

    <label for="photo">ðŸ“¸ Photo de la carte (obligatoire) :</label>
    <input type="file" id="photo" accept="image/*">

    <button onclick="ajouterCarte()">Ajouter la carte</button>
    <div id="message" class="error"></div>
  </div>

  <input type="text" id="recherche" placeholder="Rechercher une carte..." oninput="rechercherCarte()">
  <button onclick="trierParExpiration()">Trier par expiration</button>
  <div id="liste"></div>

  <script>
    let cartes = [];

    function ajouterCarte() {
      const message = document.getElementById('message');
      message.className = "error";
      message.textContent = "";

      const nom = document.getElementById('nom').value.trim();
      const solde = parseFloat(document.getElementById('solde').value);
      const expiration = document.getElementById('expiration').value;
      const photoInput = document.getElementById('photo');

      if (!nom || isNaN(solde) || !expiration) {
        message.textContent = "Merci de remplir tous les champs.";
        return;
      }

      if (photoInput.files.length === 0) {
        message.textContent = "Merci de sÃ©lectionner une photo.";
        return;
      }

      const carte = { nom, solde, expiration, photo: null, historique: [] };

      try {
        const lecteur = new FileReader();
        lecteur.onload = function () {
          carte.photo = lecteur.result;
          cartes.push(carte);
          sauvegarderCartes();
          afficherCartes();
          message.className = "success";
          message.textContent = "Carte ajoutÃ©e avec succÃ¨s.";
        };
        lecteur.onerror = function () {
          cartes.push(carte);
          sauvegarderCartes();
          afficherCartes();
          message.textContent = "Photo non lisible, carte ajoutÃ©e sans lâ€™image.";
        };
        lecteur.readAsDataURL(photoInput.files[0]);
      } catch (err) {
        cartes.push(carte);
        sauvegarderCartes();
        afficherCartes();
        message.textContent = "Erreur de chargement photo. Carte ajoutÃ©e sans image.";
      }

      document.getElementById('nom').value = "";
      document.getElementById('solde').value = "";
      document.getElementById('expiration').value = "";
      document.getElementById('photo').value = "";
    }

    function afficherCartes(cartesFiltrees = cartes) {
      const conteneur = document.getElementById('liste');
      conteneur.innerHTML = "";
      const aujourdHui = new Date();

      cartesFiltrees.forEach((carte, index) => {
        const dateExp = new Date(carte.expiration);
        const joursRestants = Math.ceil((dateExp - aujourdHui) / (1000 * 60 * 60 * 24));
        const expirationProche = joursRestants <= 7 ? "<strong>âš  Expire bientÃ´t !</strong><br>" : "";

        let historiqueHTML = "";
        if (carte.historique.length > 0) {
          historiqueHTML = "<div class='history'><strong>Historique :</strong><ul>";
          carte.historique.forEach(item => {
            historiqueHTML += `<li>- ${item.montant}â‚¬ le ${item.date}</li>`;
          });
          historiqueHTML += "</ul></div>";
        }

        const div = document.createElement('div');
        div.className = "card";
        div.innerHTML = `
          <strong>${carte.nom}</strong><br>
          Solde : ${carte.solde.toFixed(2)} â‚¬<br>
          Expire le : ${carte.expiration}<br>
          ${expirationProche}
          ${carte.photo ? `<img src="${carte.photo}" alt="photo carte">` : "<em>Pas de photo disponible</em>"}
          <div class="actions">
            <button onclick="utiliserCarte(${index})">Utiliser</button>
            <button onclick="supprimerCarte(${index})">Supprimer</button>
          </div>
          ${historiqueHTML}
        `;
        conteneur.appendChild(div);
      });
    }

    function supprimerCarte(index) {
      if (confirm("Supprimer cette carte ?")) {
        cartes.splice(index, 1);
        sauvegarderCartes();
        afficherCartes();
      }
    }

    function utiliserCarte(index) {
      const montant = parseFloat(prompt("Montant utilisÃ© (â‚¬) :"));
      if (!isNaN(montant) && montant > 0 && montant <= cartes[index].solde) {
        cartes[index].solde -= montant;
        cartes[index].historique.push({
          montant: montant.toFixed(2),
          date: new Date().toLocaleDateString()
        });
        sauvegarderCartes();
        afficherCartes();
      } else {
        alert("Montant invalide ou supÃ©rieur au solde.");
      }
    }

    function sauvegarderCartes() {
      localStorage.setItem('cartes', JSON.stringify(cartes));
    }

    function chargerCartes() {
      const stockees = localStorage.getItem('cartes');
      if (stockees) {
        cartes = JSON.parse(stockees);
        afficherCartes();
      }
    }

    function rechercherCarte() {
      const motCle = document.getElementById('recherche').value.toLowerCase();
      const filtrees = cartes.filter(c => c.nom.toLowerCase().includes(motCle));
      afficherCartes(filtrees);
    }

    function trierParExpiration() {
      cartes.sort((a, b) => new Date(a.expiration) - new Date(b.expiration));
      afficherCartes();
    }

    window.onload = chargerCartes;
  </script>
</body>
</html>
